"use strict";
var Promise = require('bluebird');
var async = require('async');
var modbus_eastron_1 = require("modbus-eastron");
var aftertimesync_1 = require("aftertimesync");
var ModEastronKernel = (function () {
    function ModEastronKernel() {
        this.devices = [];
    }
    ModEastronKernel.prototype.addDevices = function (devices) {
        if (!devices || !devices.length || !devices[0].id) {
            throw Error('wrong devices config for kernel modbus eastron');
        }
        else {
            for (var i = 0; i < devices.length; i++) {
                this.addDevice(devices[i]);
            }
        }
    };
    ModEastronKernel.prototype.addDevice = function (device) {
        if (!device || !device.id) {
            throw Error('wrong device conf for kernel modbus eastron');
        }
        else {
            this.devices.push(device);
        }
    };
    ModEastronKernel.prototype.loop = function (callback, o) {
        var _this = this;
        if (!_this.activeloop) {
            function looping() {
                var interval = 300000;
                if (o && o.interval)
                    interval = o.interval;
                function cycle() {
                    _this.activeloop = setInterval(function () {
                        this.data().then(function (a) {
                            callback(a);
                        }).catch(function (err) {
                            console.error(err);
                        });
                    }, interval);
                }
                this.data().then(function (a) {
                    callback(a);
                    cycle();
                }).catch(function (err) {
                    console.error(err);
                    cycle();
                });
            }
            if (o && o.checkTime) {
                aftertimesync_1.default().then(function () {
                    looping();
                }).catch(function (err) {
                    console.error(err);
                    throw Error(err);
                });
            }
            else {
                looping();
            }
        }
        else {
            throw Error('you must close the actual loop before start another');
        }
    };
    ModEastronKernel.prototype.loopStop = function () {
        var _this = this;
        if (_this.activeloop) {
            clearInterval(_this.activeloop);
            return 'ok';
        }
        else {
            return 'no loop are running';
        }
    };
    ModEastronKernel.prototype.data = function () {
        var devices = this.devices;
        return new Promise(function (resolve, reject) {
            var answer = [];
            async.eachSeries(devices, function (device) {
                modbus_eastron_1.default(device).then(function (a) {
                    answer.push(a);
                }).catch(function (err) {
                    console.error(err);
                });
            }, function (err) {
                if (err) {
                    reject(err);
                }
                else {
                    resolve(answer);
                }
            });
        });
    };
    return ModEastronKernel;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = ModEastronKernel;

//# sourceMappingURL=data:application/json;base64,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RUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDTixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUE7Z0JBRWYsQ0FBQztnQkFBQyxJQUFJLENBQUMsQ0FBQztvQkFDSixPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7Z0JBQ25CLENBQUM7WUFFTCxDQUFDLENBQUMsQ0FBQTtRQUVOLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQUdMLHVCQUFDO0FBQUQsQ0EvSEEsQUErSEMsSUFBQTtBQS9IRDtrQ0ErSEMsQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0ICogYXMgYXN5bmMgZnJvbSAnYXN5bmMnO1xuaW1wb3J0IE1vZEVhc3Ryb24gZnJvbSBcIm1vZGJ1cy1lYXN0cm9uXCJcbmltcG9ydCBhZnRlclN5bmMgZnJvbSBcImFmdGVydGltZXN5bmNcIlxuXG5cblxuaW50ZXJmYWNlIEVhc3Ryb25EZXZpY2Uge1xuICAgIGRldj86IHN0cmluZztcbiAgICBodWI/OiBzdHJpbmc7XG4gICAgYmF1ZDogbnVtYmVyO1xuICAgIGlkOiBudW1iZXI7XG4gICAgdWlkPzogc3RyaW5nO1xuICAgIG1vZGVsOiBzdHJpbmc7XG4gICAgY2xhc3NOYW1lPzogc3RyaW5nO1xuICAgIGRpcmVjdGlvbjogc3RyaW5nO1xufVxuXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1vZEVhc3Ryb25LZXJuZWwge1xuICAgIGRldmljZXM6IEVhc3Ryb25EZXZpY2VbXVxuICAgIGFjdGl2ZWxvb3A6IGFueTtcblxuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuZGV2aWNlcyA9IFtdXG4gICAgfVxuXG4gICAgYWRkRGV2aWNlcyhkZXZpY2VzOiBFYXN0cm9uRGV2aWNlW10pIHtcbiAgICAgICAgaWYgKCFkZXZpY2VzIHx8ICFkZXZpY2VzLmxlbmd0aCB8fCAhZGV2aWNlc1swXS5pZCkge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ3dyb25nIGRldmljZXMgY29uZmlnIGZvciBrZXJuZWwgbW9kYnVzIGVhc3Ryb24nKVxuICAgICAgICB9IGVsc2Uge1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRldmljZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFkZERldmljZShkZXZpY2VzW2ldKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIGFkZERldmljZShkZXZpY2U6IEVhc3Ryb25EZXZpY2UpIHtcbiAgICAgICAgaWYgKCFkZXZpY2UgfHwgIWRldmljZS5pZCkge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoJ3dyb25nIGRldmljZSBjb25mIGZvciBrZXJuZWwgbW9kYnVzIGVhc3Ryb24nKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5kZXZpY2VzLnB1c2goZGV2aWNlKVxuICAgICAgICB9XG5cbiAgICB9XG5cblxuICAgIGxvb3AoY2FsbGJhY2s6IEZ1bmN0aW9uLCBvPzogeyBpbnRlcnZhbD86IG51bWJlciwgY2hlY2tUaW1lPzogYm9vbGVhbiB9KSB7XG5cbiAgICAgICAgY29uc3QgX3RoaXMgPSB0aGlzO1xuICAgICAgICBpZiAoIV90aGlzLmFjdGl2ZWxvb3ApIHtcblxuXG4gICAgICAgICAgICBmdW5jdGlvbiBsb29waW5nKCkge1xuICAgICAgICAgICAgICAgIGxldCBpbnRlcnZhbCA9IDMwMDAwMFxuICAgICAgICAgICAgICAgIGlmIChvICYmIG8uaW50ZXJ2YWwpIGludGVydmFsID0gby5pbnRlcnZhbFxuXG5cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBjeWNsZSgpIHtcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuYWN0aXZlbG9vcCA9IHNldEludGVydmFsKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGF0YSgpLnRoZW4oKGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhhKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgfSwgaW50ZXJ2YWwpXG4gICAgICAgICAgICAgICAgfVxuXG5cblxuXG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhKCkudGhlbigoYSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhhKVxuICAgICAgICAgICAgICAgICAgICBjeWNsZSgpXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycilcbiAgICAgICAgICAgICAgICAgICAgY3ljbGUoKVxuICAgICAgICAgICAgICAgIH0pXG5cblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAobyAmJiBvLmNoZWNrVGltZSkge1xuICAgICAgICAgICAgICAgIGFmdGVyU3luYygpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsb29waW5nKClcbiAgICAgICAgICAgICAgICB9KS5jYXRjaCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKVxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihlcnIpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbG9vcGluZygpXG4gICAgICAgICAgICB9XG5cblxuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcigneW91IG11c3QgY2xvc2UgdGhlIGFjdHVhbCBsb29wIGJlZm9yZSBzdGFydCBhbm90aGVyJylcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgbG9vcFN0b3AoKSB7XG5cbiAgICAgICAgY29uc3QgX3RoaXMgPSB0aGlzO1xuICAgICAgICBpZiAoX3RoaXMuYWN0aXZlbG9vcCkge1xuICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChfdGhpcy5hY3RpdmVsb29wKVxuICAgICAgICAgICAgcmV0dXJuICdvaydcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiAnbm8gbG9vcCBhcmUgcnVubmluZydcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgZGF0YSgpIHtcbiAgICAgICAgY29uc3QgZGV2aWNlcyA9IHRoaXMuZGV2aWNlc1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXG4gICAgICAgICAgICBjb25zdCBhbnN3ZXIgPSBbXTtcblxuICAgICAgICAgICAgYXN5bmMuZWFjaFNlcmllcyhkZXZpY2VzLCAoZGV2aWNlKSA9PiB7XG5cbiAgICAgICAgICAgICAgICBNb2RFYXN0cm9uKGRldmljZSkudGhlbigoYSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhbnN3ZXIucHVzaChhKVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpXG4gICAgICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgfSwgKGVycikgPT4ge1xuXG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShhbnN3ZXIpXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgIH0pXG4gICAgfVxuXG5cbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
